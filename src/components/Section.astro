---
interface Props {
    id?: string;
    title?: string;
    subtitle?: string;
    background?: "white" | "light" | "dark";
    centered?: boolean;
    paddingTop?: "small" | "medium" | "large";
    paddingBottom?: "small" | "medium" | "large";
    image?: string;
    imagePosition?: "left" | "right";
    imageSize?: string;
    titleAlignment?: "left" | "center" | "right";
}

const {
    id,
    title,
    subtitle,
    background = "white",
    centered = false,
    paddingTop = "large",
    paddingBottom = "large",
    image,
    imagePosition = "right",
    imageSize = "300px",
    titleAlignment = "center",
} = Astro.props;

const paddingClasses = `pt-${paddingTop} pb-${paddingBottom}`;
const bgClass = `bg-${background}`;
const textAlign = centered ? "centered" : "";
const titleAlignClass = title ? `title-${titleAlignment}` : "";
---

<section
    id={id}
    class={`section ${bgClass} ${paddingClasses} ${textAlign} ${titleAlignClass}`}
>
    <div class="container">
        {
            title && (
                <div class="section-header">
                    <h2 class="section-title">{title}</h2>
                    {subtitle && <p class="section-subtitle">{subtitle}</p>}
                </div>
            )
        }

        {
            image ? (
                <div class={`content-row image-${imagePosition}`}>
                    {imagePosition === "left" && (
                        <img
                            src={image}
                            alt=""
                            class="section-image"
                            style={`width: ${imageSize}; height: auto;`}
                        />
                    )}
                    <div class="section-content">
                        <slot />
                    </div>
                    {imagePosition === "right" && (
                        <img
                            src={image}
                            alt=""
                            class="section-image"
                            style={`width: ${imageSize}; height: auto;`}
                        />
                    )}
                </div>
            ) : (
                <div class="section-content">
                    <slot />
                </div>
            )
        }
    </div>
</section>

<style>
    .section {
        width: 100%;
        position: relative;
    }

    .section::before {
        content: "";
        position: absolute;
        top: -1px;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(0, 102, 204, 0.1) 10%,
            rgba(0, 102, 204, 0.3) 50%,
            rgba(0, 102, 204, 0.1) 90%,
            transparent 100%
        );
    }

    .section::after {
        content: "";
        position: absolute;
        top: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(0, 102, 204, 0.6) 50%,
            transparent 100%
        );
        box-shadow: 0 0 20px rgba(0, 102, 204, 0.3);
    }

    .bg-white {
        background: #ffffff;
    }
    .bg-light {
        background: #f8f9fa;
    }
    .bg-dark {
        background: #1a1a1a;
        color: #ffffff;
    }

    .pt-small {
        padding-top: 3rem;
    }

    .pt-medium {
        padding-top: 5rem;
    }

    .pt-large {
        padding-top: 7rem;
    }

    .pb-small {
        padding-bottom: 3rem;
    }

    .pb-medium {
        padding-bottom: 5rem;
    }

    .pb-large {
        padding-bottom: 7rem;
    }

    .container {
        max-width: var(--container);
        margin: 0 auto;
        padding: 0 2rem;
    }

    .section-header {
        margin-bottom: 3rem;
    }

    .centered .section-header {
        text-align: center;
    }

    /* Title alignments */
    .title-left .section-header {
        text-align: left;
    }

    .title-center .section-header {
        text-align: center;
    }

    .title-right .section-header {
        text-align: right;
    }

    /* Content row with image */
    .content-row {
        display: grid;
        gap: 3rem;
        align-items: start;
    }

    .content-row.image-left {
        grid-template-columns: auto minmax(0, 1fr);
    }

    .content-row.image-right {
        grid-template-columns: minmax(0, 1fr) auto;
    }

    .section-title {
        font-size: clamp(2rem, 7vw, 4rem);
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        letter-spacing: -0.02em;
        line-height: 1.1;
    }

    .section-subtitle {
        font-size: clamp(1rem, 2vw, 1.125rem);
        color: var(--muted);
        margin: 0;
        line-height: 1.6;
        font-weight: 500;
    }

    .bg-dark .section-subtitle {
        color: #ccc;
    }

    .section-content {
        width: 100%;
        min-width: 0;
        overflow-wrap: break-word;
    }

    .section-image {
        max-width: 100%;
        height: auto;
        object-fit: contain;
        flex-shrink: 0;
    }

    @media (max-width: 768px) {
        .pt-small {
            padding-top: 2rem;
        }

        .pt-medium {
            padding-top: 3rem;
        }

        .pt-large {
            padding-top: 4rem;
        }

        .pb-small {
            padding-bottom: 2rem;
        }

        .pb-medium {
            padding-bottom: 3rem;
        }

        .pb-large {
            padding-bottom: 4rem;
        }

        .container {
            padding: 0 1.5rem;
        }

        .section-title {
            font-size: 1.75rem;
        }
        .section-subtitle {
            font-size: 1rem;
        }

        .section-header {
            margin-bottom: 2rem;
        }

        /* Reset grid layout on mobile */
        .content-row {
            display: block !important;
        }
    }

    /* Initial blurred state before element is in viewport. */
    .section.will-blur {
        filter: blur(8px) saturate(0.98);
        opacity: 0.95;
        transform: translateY(8px);
        transition:
            filter 700ms cubic-bezier(0.2, 0.9, 0.3, 1),
            opacity 500ms ease,
            transform 650ms cubic-bezier(0.2, 0.9, 0.3, 1);
        will-change: transform, filter, opacity;
    }

    .section.in-view {
        filter: none;
        opacity: 1;
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .section.will-blur {
            filter: blur(4px) saturate(0.99);
            transform: translateY(4px);
        }
    }
</style>

<script type="module">
    if (typeof window !== "undefined") {
        // Avoid installing multiple observers if the component renders many times
        if (!window.__sectionsObserverInitialized) {
            window.__sectionsObserverInitialized = true;

            const observer = new IntersectionObserver(
                (entries, obs) => {
                    entries.forEach((entry) => {
                        const el = entry.target;
                        if (entry.isIntersecting) {
                            el.classList.add("in-view");
                            el.classList.remove("will-blur");
                            obs.unobserve(el);
                        }
                    });
                },
                { root: null, rootMargin: "0px 0px -10% 0px", threshold: 0.15 },
            );

            // Observe all section elements on the page and mark them initially to be blurred.
            document.querySelectorAll("section.section").forEach((s) => {
                s.classList.add("will-blur");
                observer.observe(s);
            });
        }
    }
</script>
